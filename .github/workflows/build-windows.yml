name: Build Windows Executable

on:
  push:
    branches: [ main ]
    paths: 
      - 'standalone-whisper/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'standalone-whisper/**'
  workflow_dispatch:  # Allow manual trigger

jobs:
  build-windows:
    runs-on: windows-latest
    defaults:
      run:
        working-directory: standalone-whisper
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Build Windows executable
      shell: cmd
      run: |
        python -m PyInstaller ^
          --onefile ^
          --name=whisper-standalone ^
          --distpath=dist ^
          --workpath=build ^
          --specpath=build ^
          --clean ^
          --noconfirm ^
          --console ^
          --hidden-import=faster_whisper ^
          --hidden-import=faster_whisper.transcribe ^
          --hidden-import=faster_whisper.vad ^
          --hidden-import=torch ^
          --hidden-import=ctranslate2 ^
          --hidden-import=tokenizers ^
          --hidden-import=huggingface_hub ^
          --hidden-import=numpy ^
          --hidden-import=onnxruntime ^
          --optimize=2 ^
          --log-level=WARN ^
          whisper-cli.py
    
    - name: Upload executable
      uses: actions/upload-artifact@v4
      with:
        name: whisper-standalone-windows
        path: standalone-whisper/dist/whisper-standalone.exe
        if-no-files-found: error
    
    - name: Test executable
      run: |
        dist\whisper-standalone.exe --version
    
    # Optional: Create release on tags
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Release ${{ github.ref }}
        draft: false
        prerelease: false
    
    - name: Upload Release Asset
      if: startsWith(github.ref, 'refs/tags/v')
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: standalone-whisper/dist/whisper-standalone.exe
        asset_name: whisper-standalone.exe
        asset_content_type: application/octet-stream